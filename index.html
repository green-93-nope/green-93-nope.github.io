<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"summerisgreen.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Abracadabra">
<meta property="og:type" content="website">
<meta property="og:title" content="Summer is Green">
<meta property="og:url" content="http://summerisgreen.com/index.html">
<meta property="og:site_name" content="Summer is Green">
<meta property="og:description" content="Abracadabra">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Summer is Green">
<meta name="twitter:description" content="Abracadabra">

<link rel="canonical" href="http://summerisgreen.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>Summer is Green</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Summer is Green</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">a blog for writing and thinking</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://summerisgreen.com/blog/2020-09-11-2020-09-11-算法技巧-寻找递增序列长度.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/author.png">
      <meta itemprop="name" content="Green">
      <meta itemprop="description" content="Abracadabra">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Summer is Green">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020-09-11-2020-09-11-算法技巧-寻找递增序列长度.html" class="post-title-link" itemprop="url">算法技巧-寻找递增序列长度</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-11 00:00:00" itemprop="dateCreated datePublished" datetime="2020-09-11T00:00:00+08:00">2020-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-12 10:21:38" itemprop="dateModified" datetime="2020-09-12T10:21:38+08:00">2020-09-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程技巧/" itemprop="url" rel="index"><span itemprop="name">编程技巧</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
<div id="outline-container-org1054734" class="outline-2">
<h2 id="org1054734">最长上升子序列问题</h2>
<div class="outline-text-2" id="text-org1054734">
<p>
leetcode 300
</p>
<pre class="example">
给定一个无序的整数数组，找到其中最长上升子序列的长度。
</pre>

<p>
比较容易想到的解法是构造长度为n的数组，其第i位表示:第i个数字为最长子序列最后一位时的长度。
该解法即动态规划，其迭代式为: v[j] = max(v[j], v[i]+1), j &gt; i &gt;= 0。该算法的时间复杂度为O(n^2)。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">lengthOfLIS</span><span style="color: #4f97d7;">(</span>nums: List<span style="color: #bc6ec5;">[</span><span style="color: #4f97d7;">int</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> -&gt; <span style="color: #4f97d7;">int</span>:
    <span style="color: #7590db;">size</span> = <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>nums<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">ans</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span> * size
    <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span>size<span style="color: #4f97d7;">)</span>:
        <span style="color: #7590db;">cur_val</span> = nums<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> j <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>, i<span style="color: #4f97d7;">)</span>:
            <span style="color: #4f97d7; font-weight: bold;">if</span> cur_val &gt; nums<span style="color: #4f97d7;">[</span>j<span style="color: #4f97d7;">]</span>:
                <span style="color: #7590db;">ans</span><span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">max</span><span style="color: #4f97d7;">(</span>ans<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>, ans<span style="color: #bc6ec5;">[</span>j<span style="color: #bc6ec5;">]</span> + <span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>ans<span style="color: #4f97d7;">)</span> == <span style="color: #a45bad;">0</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7;">max</span><span style="color: #4f97d7;">(</span>ans<span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
对于结果队列，下标i表示长度为i的递增序列的最后一位，其数值为该位的最小值。
通过二分法可以在O(log^n)的时间复杂度内完成替换，总时间复杂度为O(nlog^n)
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> bisect
<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">lengthOfLIS</span><span style="color: #4f97d7;">(</span>nums: List<span style="color: #bc6ec5;">[</span><span style="color: #4f97d7;">int</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> -&gt; <span style="color: #4f97d7;">int</span>:
    <span style="color: #7590db;">size</span> = <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>nums<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">queue</span> = <span style="color: #4f97d7;">[]</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span>size<span style="color: #4f97d7;">)</span>:
        <span style="color: #7590db;">cur_val</span> = nums<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>
        <span style="color: #7590db;">index</span> = bisect.bisect_left<span style="color: #4f97d7;">(</span>queue, cur_val<span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> index == <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>ans<span style="color: #4f97d7;">)</span>:
            queue.append<span style="color: #4f97d7;">(</span>cur_val<span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span>:
            <span style="color: #7590db;">queue</span><span style="color: #4f97d7;">[</span>index<span style="color: #4f97d7;">]</span> = cur_val
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>queue<span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
利用同样的思路可以解决二维的递增序列问题。
</p>
</div>
</div>

<div id="outline-container-org9629a3b" class="outline-2">
<h2 id="org9629a3b">马戏团人塔问题</h2>
<div class="outline-text-2" id="text-org9629a3b">
<pre class="example">
有个马戏团正在设计叠罗汉的表演节目，一个人要站在另一人的肩膀上。
出于实际和美观的考虑，在上面的人要比下面的人矮一点且轻一点。
已知马戏团每个人的身高和体重，请编写代码计算叠罗汉最多能叠几个人。
</pre>

<p>
将需要迭罗汉的人员按序排列(1.身高升序2.体重降序)后，值为体重，即转化为之前的最长递增子序列问题。
由于身高相同的人，不能迭罗汉，而只能选取一个，最矮的最优，所以要对其降序排列。
此时对于结果队列，下标i表示自上而下的i层人塔的最底层的体重最小值。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> bisect
<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">bestSeqAtIndex</span><span style="color: #4f97d7;">(</span>height: List<span style="color: #bc6ec5;">[</span><span style="color: #4f97d7;">int</span><span style="color: #bc6ec5;">]</span>, weight: List<span style="color: #bc6ec5;">[</span><span style="color: #4f97d7;">int</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> -&gt; <span style="color: #4f97d7;">int</span>:
    <span style="color: #7590db;">ans</span>, <span style="color: #7590db;">size</span> = <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>height<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">sortedArr</span> = <span style="color: #4f97d7;">sorted</span><span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">(</span>height<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span>, weight<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span> <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #2d9574;">(</span>size<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">]</span>, key = <span style="color: #4f97d7; font-weight: bold;">lambda</span> pair: <span style="color: #bc6ec5;">(</span>pair<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span>, -pair<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>  <span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">queue</span> = <span style="color: #4f97d7;">[]</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> item <span style="color: #4f97d7; font-weight: bold;">in</span> sortedArr:
        <span style="color: #7590db;">index</span> = bisect.bisect_left<span style="color: #4f97d7;">(</span>queue, item<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> index == <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>queue<span style="color: #4f97d7;">)</span>:
            queue.append<span style="color: #4f97d7;">(</span>item<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span>:
            <span style="color: #7590db;">queue</span><span style="color: #4f97d7;">[</span>index<span style="color: #4f97d7;">]</span> = item<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>queue<span style="color: #4f97d7;">)</span>
</pre>
</div>
</div>
</div>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://summerisgreen.com/blog/2020-02-07-2020-02-03-forkjoin中的窃取机制.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/author.png">
      <meta itemprop="name" content="Green">
      <meta itemprop="description" content="Abracadabra">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Summer is Green">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020-02-07-2020-02-03-forkjoin中的窃取机制.html" class="post-title-link" itemprop="url">ForkJoin中的窃取机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-02-07 00:00:00 / Modified: 12:45:54" itemprop="dateCreated datePublished" datetime="2020-02-07T00:00:00+08:00">2020-02-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>
从jdk1.7开始，jdk提供了ForkJoin相关工具类。
与其他ExecutorService实现相比，其能够充分地利用多核优势来提高执行性能:
</p>
<ol class="org-ol">
<li>通过采用工作窃取算法，使得未被分配任务的工作线程也能从忙碌线程那窃取任务协助执行。</li>
<li>抽象ForkJoinTask提供了模板方法，以更好地支持将大任务拆分成小任务的分而治冶思想。</li>
</ol>

<p>
本文基于jdk13的代码，来探讨下ForkJoin框架对于任务何时窃取，以及怎么窃取的问题。
</p>

<div id="outline-container-orge49b0c0" class="outline-2">
<h2 id="orge49b0c0">WorkQueue</h2>
<div class="outline-text-2" id="text-orge49b0c0">
<p>
ForkJoinPool中的WorkQueue被声明为数组形式，其通过区分外部提交和任务执行过程中产生的任务，
优先执行提交任务所产生的子任务，从而优先完成已经开始执行的提交任务。
该数组根据任务的来源区分为:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="org-left">

<col class="org-left">

<col class="org-left">

<col class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">数组下标</td>
<td class="org-left">任务来源</td>
<td class="org-left">是否有绑定执行线程</td>
<td class="org-left">被窃取方式</td>
</tr>

<tr>
<td class="org-left">奇数</td>
<td class="org-left">ForkJoinTask产生的子任务</td>
<td class="org-left">绑定ForkJoinWorkerThread</td>
<td class="org-left">1.runWorker中的scan方法，2.awaitJoin方法窃取的队列任务</td>
</tr>

<tr>
<td class="org-left">偶数</td>
<td class="org-left">外部提交(非ForkJoinWorkerThread)</td>
<td class="org-left">否</td>
<td class="org-left">1.runWorker中的scan方法</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #ce537a; font-weight: bold;">WorkQueue</span><span style="color: #4f97d7;">[]</span> <span style="color: #7590db;">workQueues</span>;              <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">main registry</span>
</pre>
</div>

<p>
从上面的表格可以看出，窃取分为工作线程主循环中的例程性窃取和join阻塞时辅助性窃取。
</p>
</div>
</div>

<div id="outline-container-org89d01c3" class="outline-2">
<h2 id="org89d01c3">主循环中的例程性窃取</h2>
<div class="outline-text-2" id="text-org89d01c3">
<p>
例程性的工作窃取是发生在工作线程主循环中调用链:forkJoinWorkerThread.run() -&gt; pool.runWorker(workQueue) -&gt; scan(workQueue, r)中的scan方法。
其保证了优先完成已开始执行的ForkJoin任务，并且外部提交的任务在任务较多时不发生饥饿现象。
</p>

<p>
通过scan方法可以看出，其根据调用方runWorker方法所传入的随机数r开始，查找非空的窃取队列。
找到后即调用当前forkJoinWorkerThread对应WorkQueue的topLevelExec，开始常规性运行过程。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">scan</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">WorkQueue</span> <span style="color: #7590db;">w</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">r</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">WorkQueue</span><span style="color: #bc6ec5;">[]</span> <span style="color: #7590db;">ws</span>; <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">n</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ws = workQueues<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">null</span> &amp;&amp; <span style="color: #2d9574;">(</span>n = ws.length<span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span> &amp;&amp; w != <span style="color: #a45bad;">null</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">m</span> = n - <span style="color: #a45bad;">1</span>, <span style="color: #7590db;">j</span> = r &amp; m;;<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #ce537a; font-weight: bold;">WorkQueue</span> <span style="color: #7590db;">q</span>; <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">b</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>q = ws<span style="color: #4f97d7;">[</span>j<span style="color: #4f97d7;">]</span><span style="color: #b1951d;">)</span> != <span style="color: #a45bad;">null</span> &amp;&amp; q.top != <span style="color: #b1951d;">(</span>b = q.base<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">qid</span> = q.id;
                <span style="color: #ce537a; font-weight: bold;">ForkJoinTask</span><span style="color: #b1951d;">&lt;</span>?<span style="color: #b1951d;">&gt;[]</span> <span style="color: #7590db;">a</span>; <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">cap</span>, <span style="color: #7590db;">k</span>; <span style="color: #ce537a; font-weight: bold;">ForkJoinTask</span><span style="color: #b1951d;">&lt;</span>?<span style="color: #b1951d;">&gt;</span> <span style="color: #7590db;">t</span>;
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">(</span>a = q.array<span style="color: #4f97d7;">)</span> != <span style="color: #a45bad;">null</span> &amp;&amp; <span style="color: #4f97d7;">(</span>cap = a.length<span style="color: #4f97d7;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">{</span>
                    t = <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">ForkJoinTask</span><span style="color: #bc6ec5;">&lt;</span>?<span style="color: #bc6ec5;">&gt;</span><span style="color: #4f97d7;">)</span>QA.getAcquire<span style="color: #4f97d7;">(</span>a, k = <span style="color: #bc6ec5;">(</span>cap - <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> &amp; b<span style="color: #4f97d7;">)</span>;
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>q.base == b++ &amp;&amp; t != <span style="color: #a45bad;">null</span> &amp;&amp;
                        QA.compareAndSet<span style="color: #bc6ec5;">(</span>a, k, t, <span style="color: #a45bad;">null</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        q.base = b;
                        w.source = qid;
                        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>a<span style="color: #2d9574;">[</span><span style="color: #9cb6ad;">(</span>cap - <span style="color: #a45bad;">1</span><span style="color: #9cb6ad;">)</span> &amp; b<span style="color: #2d9574;">]</span> != <span style="color: #a45bad;">null</span><span style="color: #bc6ec5;">)</span>
                            signalWork<span style="color: #bc6ec5;">(</span>q<span style="color: #bc6ec5;">)</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">help signal if more tasks</span>
                        w.topLevelExec<span style="color: #bc6ec5;">(</span>t, q,  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">random fairness bound</span>
                                       <span style="color: #2d9574;">(</span>r | <span style="color: #9cb6ad;">(</span><span style="color: #a45bad;">1</span> &lt;&lt; TOP_BOUND_SHIFT<span style="color: #9cb6ad;">)</span><span style="color: #2d9574;">)</span> &amp; SMASK<span style="color: #bc6ec5;">)</span>;
                    <span style="color: #4f97d7;">}</span>
                <span style="color: #b1951d;">}</span>
                <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">true</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>--n &gt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>
                j = <span style="color: #67b11d;">(</span>j + <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span> &amp; m;
            <span style="color: #4f97d7; font-weight: bold;">else</span>
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">false</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
topLevelExec方法是执行本地队列任务及窃取任务的主要方法，窃取任务从指定窃取队列以FIFO的顺序取出;
而本地队列FIFO还是LIFO，则由构造器方法中的asyncMode决定（默认为false，也就是LIFO）。
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #bc6ec5; font-weight: bold;">ForkJoinPool</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">parallelism</span>,
                    <span style="color: #ce537a; font-weight: bold;">ForkJoinWorkerThreadFactory</span> <span style="color: #7590db;">factory</span>,
                    <span style="color: #ce537a; font-weight: bold;">UncaughtExceptionHandler</span> <span style="color: #7590db;">handler</span>,
                    <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">asyncMode</span><span style="color: #4f97d7;">)</span>

mode = parallelism | <span style="color: #4f97d7;">(</span>asyncMode ? FIFO : <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<p>
考虑到调用该方法时，本地队列中必定是不存在任务的，因此该次调用中直接执行窃取队列首部的ForkJoinTask。
之后每执行n次(&gt;= 2^10)本地队列任务，尝试执行一次窃取队列任务。
当本地及窃取队列均没有待执行任务时，返回到runWork方法，调整窃取的随机数r后，继续调用scan方法寻找合适的窃取队列。
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">topLevelExec</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">ForkJoinTask</span><span style="color: #bc6ec5;">&lt;</span>?<span style="color: #bc6ec5;">&gt;</span> <span style="color: #7590db;">t</span>, <span style="color: #ce537a; font-weight: bold;">WorkQueue</span> <span style="color: #7590db;">q</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">n</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">nstolen</span> = <span style="color: #a45bad;">1</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">j</span> = <span style="color: #a45bad;">0</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>t != <span style="color: #a45bad;">null</span><span style="color: #2d9574;">)</span>
            t.doExec<span style="color: #2d9574;">()</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>j++ &lt;= n<span style="color: #2d9574;">)</span>
            t = nextLocalTask<span style="color: #2d9574;">()</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            j = <span style="color: #a45bad;">0</span>;
            t = <span style="color: #a45bad;">null</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>t == <span style="color: #a45bad;">null</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>q != <span style="color: #a45bad;">null</span> &amp;&amp; <span style="color: #b1951d;">(</span>t = q.poll<span style="color: #4f97d7;">()</span><span style="color: #b1951d;">)</span> != <span style="color: #a45bad;">null</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                ++nstolen;
                j = <span style="color: #a45bad;">0</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>j != <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #ce537a; font-weight: bold;">ForkJoinWorkerThread</span> <span style="color: #7590db;">thread</span> = owner;
    nsteals += nstolen;
    source = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>thread != <span style="color: #a45bad;">null</span><span style="color: #bc6ec5;">)</span>
        thread.afterTopLevelExec<span style="color: #bc6ec5;">()</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd5a8d90" class="outline-2">
<h2 id="orgd5a8d90">join阻塞时的窃取</h2>
<div class="outline-text-2" id="text-orgd5a8d90">
<p>
forkjoin任务的join操作主要是通过调用doJoin方法来完成的。
在该方法中，可以看到其根据当前线程是否是forkjoin工作线程(ForkJoinWorkerThread)分别采取两种不同的策略。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">doJoin</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">s</span>; <span style="color: #ce537a; font-weight: bold;">Thread</span> <span style="color: #7590db;">t</span>; <span style="color: #ce537a; font-weight: bold;">ForkJoinWorkerThread</span> <span style="color: #7590db;">wt</span>; <span style="color: #a45bad;">ForkJoinPool</span>.<span style="color: #ce537a; font-weight: bold;">WorkQueue</span> <span style="color: #7590db;">w</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>s = status<span style="color: #bc6ec5;">)</span> &lt; <span style="color: #a45bad;">0</span> ? s :
        <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>t = Thread.currentThread<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> <span style="color: #4f97d7; font-weight: bold;">instanceof</span> ForkJoinWorkerThread<span style="color: #bc6ec5;">)</span> ?
        <span style="color: #bc6ec5;">(</span>w = <span style="color: #2d9574;">(</span>wt = <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">ForkJoinWorkerThread</span><span style="color: #67b11d;">)</span>t<span style="color: #2d9574;">)</span>.workQueue<span style="color: #bc6ec5;">)</span>.
        tryUnpush<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #bc6ec5;">)</span> &amp;&amp; <span style="color: #bc6ec5;">(</span>s = doExec<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span> &lt; <span style="color: #a45bad;">0</span> ? s :
        wt.pool.awaitJoin<span style="color: #bc6ec5;">(</span>w, <span style="color: #4f97d7; font-weight: bold;">this</span>, <span style="color: #a45bad;">0L</span><span style="color: #bc6ec5;">)</span> :
        externalAwaitDone<span style="color: #bc6ec5;">()</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
<div id="outline-container-orga3d1f31" class="outline-3">
<h3 id="orga3d1f31">非ForkJoinWorkerThread的Join</h3>
<div class="outline-text-3" id="text-orga3d1f31">
<p>
对于非ForkJoinWorkerThread的外部线程来说，其不会窃取执行其他任务。
只会在阻塞等待任务前，调用tryExternalHelp方法，尝试当前线程直接执行提交任务。
是否能直接执行提交任务，取决于是否能够满足下面三个条件。
值得注意的是，外部线程执行过程中产生的子任务将提交到common池(ForkJoinPool.common)中。
</p>
<ol class="org-ol">
<li>任务提交在common池中</li>
<li>任务提交时的线程Probe值和当前的指向同一个提交队列</li>
<li>任务位于队列尾部</li>
</ol>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">tryExternalHelp</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">s</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>s = status<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span> ? s:
            <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span> <span style="color: #4f97d7; font-weight: bold;">instanceof</span> CountedCompleter<span style="color: #2d9574;">)</span> ?
            ForkJoinPool.common.externalHelpComplete<span style="color: #2d9574;">(</span>
                <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">CountedCompleter</span><span style="color: #b1951d;">&lt;</span>?<span style="color: #b1951d;">&gt;</span><span style="color: #67b11d;">)</span><span style="color: #4f97d7; font-weight: bold;">this</span>, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> :
            ForkJoinPool.common.tryExternalUnpush<span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #2d9574;">)</span> ?
            doExec<span style="color: #2d9574;">()</span> : <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">tryExternalUnpush</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">ForkJoinTask</span><span style="color: #bc6ec5;">&lt;</span>?<span style="color: #bc6ec5;">&gt;</span> <span style="color: #7590db;">task</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">r</span> = ThreadLocalRandom.getProbe<span style="color: #bc6ec5;">()</span>;
    <span style="color: #ce537a; font-weight: bold;">WorkQueue</span><span style="color: #bc6ec5;">[]</span> <span style="color: #7590db;">ws</span>; <span style="color: #ce537a; font-weight: bold;">WorkQueue</span> <span style="color: #7590db;">w</span>; <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">n</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ws = workQueues<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">null</span> &amp;&amp;
            <span style="color: #2d9574;">(</span>n = ws.length<span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span> &amp;&amp;
            <span style="color: #2d9574;">(</span>w = ws<span style="color: #67b11d;">[</span><span style="color: #b1951d;">(</span>n - <span style="color: #a45bad;">1</span><span style="color: #b1951d;">)</span> &amp; r &amp; SQMASK<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">null</span> &amp;&amp;
            w.tryLockedUnpush<span style="color: #2d9574;">(</span>task<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org96a8307" class="outline-3">
<h3 id="org96a8307">ForkJoinWorkerThread的Join</h3>
<div class="outline-text-3" id="text-org96a8307">
<p>
对于forkjoin工作线程来说，当等待join的任务位于当前线程的工作队列尾部时，尝试直接执行当前任务。
否则调用forkJoinWorkerThread.pool.awaitJoin方法。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">doJoin</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">s</span>; <span style="color: #ce537a; font-weight: bold;">Thread</span> <span style="color: #7590db;">t</span>; <span style="color: #ce537a; font-weight: bold;">ForkJoinWorkerThread</span> <span style="color: #7590db;">wt</span>; <span style="color: #a45bad;">ForkJoinPool</span>.<span style="color: #ce537a; font-weight: bold;">WorkQueue</span> <span style="color: #7590db;">w</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>s = status<span style="color: #bc6ec5;">)</span> &lt; <span style="color: #a45bad;">0</span> ? s :
        <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>t = Thread.currentThread<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> <span style="color: #4f97d7; font-weight: bold;">instanceof</span> ForkJoinWorkerThread<span style="color: #bc6ec5;">)</span> ?
        <span style="color: #bc6ec5;">(</span>w = <span style="color: #2d9574;">(</span>wt = <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">ForkJoinWorkerThread</span><span style="color: #67b11d;">)</span>t<span style="color: #2d9574;">)</span>.workQueue<span style="color: #bc6ec5;">)</span>.
        tryUnpush<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #bc6ec5;">)</span> &amp;&amp; <span style="color: #bc6ec5;">(</span>s = doExec<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span> &lt; <span style="color: #a45bad;">0</span> ? s :
        wt.pool.awaitJoin<span style="color: #bc6ec5;">(</span>w, <span style="color: #4f97d7; font-weight: bold;">this</span>, <span style="color: #a45bad;">0L</span><span style="color: #bc6ec5;">)</span> :
        externalAwaitDone<span style="color: #bc6ec5;">()</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
在awaitJoin方法中，其首先通过tryRemoveAndExec方法，在w(本地工作队列)中查找并执行等待join的任务。
如果依旧是未完成状态，其将进行如下的窃取循环:
</p>
<ol class="org-ol">
<li>在子任务工作队列(奇数索引)中窃取队列头部的task执行。</li>
<li>任务完成则退出。</li>
<li>当子任务工作队列均为空队列，且tryCompensate方法返回值非0，则阻塞至deadline，否则重新进行窃取循环。</li>
</ol>

<p>
tryCompensate方法在没有足够的工作线程时，会创建或激活一个空闲线程来补偿join线程阻塞导致的并行度不足。
该方法返回0表示需要重试，其仅在工作队列状态不一致或cas更新状态失败时出现。
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">awaitJoin</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">WorkQueue</span> <span style="color: #7590db;">w</span>, <span style="color: #ce537a; font-weight: bold;">ForkJoinTask</span><span style="color: #bc6ec5;">&lt;</span>?<span style="color: #bc6ec5;">&gt;</span> <span style="color: #7590db;">task</span>, <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">deadline</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">s</span> = <span style="color: #a45bad;">0</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">seed</span> = ThreadLocalRandom.nextSecondarySeed<span style="color: #bc6ec5;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>w != <span style="color: #a45bad;">null</span> &amp;&amp; task != <span style="color: #a45bad;">null</span> &amp;&amp;
        <span style="color: #2d9574;">(</span><span style="color: #a45bad;">!</span><span style="color: #67b11d;">(</span>task <span style="color: #4f97d7; font-weight: bold;">instanceof</span> CountedCompleter<span style="color: #67b11d;">)</span> ||
         <span style="color: #67b11d;">(</span>s = w.helpCC<span style="color: #b1951d;">(</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">CountedCompleter</span><span style="color: #bc6ec5;">&lt;</span>?<span style="color: #bc6ec5;">&gt;</span><span style="color: #4f97d7;">)</span>task, <span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">false</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &gt;= <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        w.tryRemoveAndExec<span style="color: #2d9574;">(</span>task<span style="color: #2d9574;">)</span>;
        <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">src</span> = w.source, <span style="color: #7590db;">id</span> = w.id;
        <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">r</span> = <span style="color: #2d9574;">(</span>seed &gt;&gt;&gt; <span style="color: #a45bad;">16</span><span style="color: #2d9574;">)</span> | <span style="color: #a45bad;">1</span>, <span style="color: #7590db;">step</span> = <span style="color: #2d9574;">(</span>seed &amp; ~<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> | <span style="color: #a45bad;">2</span>;
        s = task.status;
        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>s &gt;= <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #ce537a; font-weight: bold;">WorkQueue</span><span style="color: #67b11d;">[]</span> <span style="color: #7590db;">ws</span>;
            <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">n</span> = <span style="color: #67b11d;">(</span>ws = workQueues<span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">null</span> ? <span style="color: #a45bad;">0</span> : ws.length, <span style="color: #7590db;">m</span> = n - <span style="color: #a45bad;">1</span>;
            <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #67b11d;">(</span>n &gt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #ce537a; font-weight: bold;">WorkQueue</span> <span style="color: #7590db;">q</span>; <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">b</span>;
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">(</span>q = ws<span style="color: #bc6ec5;">[</span>r &amp; m<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> != <span style="color: #a45bad;">null</span> &amp;&amp; q.source == id &amp;&amp;
                    q.top != <span style="color: #4f97d7;">(</span>b = q.base<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">{</span>
                     <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">&#25191;&#34892;&#38431;&#21015;&#22836;&#37096;&#20219;&#21153; */</span>
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #b1951d;">}</span>
                <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #b1951d;">{</span>
                    r += step;
                    --n;
                <span style="color: #b1951d;">}</span>
            <span style="color: #67b11d;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>s = task.status<span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>n == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">empty scan</span>
                <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">ms</span>, <span style="color: #7590db;">ns</span>; <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">block</span>;
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">(</span>ns = deadline - System.nanoTime<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span> &lt;= <span style="color: #a45bad;">0L</span><span style="color: #b1951d;">)</span>
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;                         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">timeout</span>
                <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">(</span>ms = <span style="color: #a45bad;">TimeUnit</span>.NANOSECONDS.toMillis<span style="color: #bc6ec5;">(</span>ns<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> &lt;= <span style="color: #a45bad;">0L</span><span style="color: #b1951d;">)</span>
                    ms = <span style="color: #a45bad;">1L</span>;                       <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">avoid 0 for timed wait</span>
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">(</span>block = tryCompensate<span style="color: #bc6ec5;">(</span>w<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">{</span>
                    task.internalWait<span style="color: #4f97d7;">(</span>ms<span style="color: #4f97d7;">)</span>;
                    CTL.getAndAdd<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>, <span style="color: #bc6ec5;">(</span>block &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> ? RC_UNIT : <span style="color: #a45bad;">0L</span><span style="color: #4f97d7;">)</span>;
                <span style="color: #b1951d;">}</span>
                s = task.status;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> s;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
</div>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://summerisgreen.com/blog/2020-02-02-2020-02-02-schedulethreadpool中的leader-follow模式.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/author.png">
      <meta itemprop="name" content="Green">
      <meta itemprop="description" content="Abracadabra">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Summer is Green">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2020-02-02-2020-02-02-schedulethreadpool中的leader-follow模式.html" class="post-title-link" itemprop="url">ScheduledThreadPool中的Leader-Follow模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-02 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-02T00:00:00+08:00">2020-02-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-03 14:13:16" itemprop="dateModified" datetime="2020-02-03T14:13:16+08:00">2020-02-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>
ScheduledThreadPoolExecutor 是java中一个非常常用的定时调度的工具，其提供了两种定时调度常用模式:
1.固定调度周期的任务执行。
2.固定延迟间隔的任务执行，延迟间隔表示的是前一次执行完成到后一次执行开始的时间差。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">1</span>.scheduleAtFixedRate<span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">Runnable</span> <span style="color: #7590db;">command</span>,<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">initialDelay</span>,<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">period</span>,<span style="color: #ce537a; font-weight: bold;">TimeUnit</span> <span style="color: #7590db;">unit</span><span style="color: #4f97d7;">)</span>
<span style="color: #a45bad;">2</span>.scheduleWithFixedDelay<span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">Runnable</span> <span style="color: #7590db;">command</span>,<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">initialDelay</span>,<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">delay</span>,<span style="color: #ce537a; font-weight: bold;">TimeUnit</span> <span style="color: #7590db;">unit</span><span style="color: #4f97d7;">)</span> 
</pre>
</div>

<p>
ScheduledThreadPoolExecutor 是基于ThreadPoolExecutor实现的，其继承了类ThreadPoolExecutor。
从构造器可以看出，为满足定时调度的需求，其基于ThreadPoolExecutor定制了延迟工作队列DelayedWorkQueue。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #bc6ec5; font-weight: bold;">ScheduledThreadPoolExecutor</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">corePoolSize</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
     <span style="color: #4f97d7; font-weight: bold;">super</span><span style="color: #bc6ec5;">(</span>corePoolSize, <span style="color: #a45bad;">Integer</span>.MAX_VALUE,
           DEFAULT_KEEPALIVE_MILLIS <span style="color: #2aa1ae; background-color: #292e34;">/*</span><span style="color: #2aa1ae; background-color: #292e34;">10L*/</span>, MILLISECONDS,
           <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">DelayedWorkQueue</span><span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
DelayedWorkQueue是一个基于最小堆的队列，其在元素进出队列等BlockingQueue接口方法中使用可重入锁，以保证线程安全。
为了在O(1)的时间取消特定任务的调度，ScheduleFutrueTask对象中还额外增加了heapIndex字段，以记录其在最小堆中的位置。
</p>

<div id="outline-container-orgd5da137" class="outline-2">
<h2 id="orgd5da137">Leader-Follower模式</h2>
<div class="outline-text-2" id="text-orgd5da137">
<p>
定时调度线程池与一般线程池的一个重要不同:提交的任务是延迟而非立即执行的，因此worker线程调用队列的take以取出执行任务必定是要阻塞的。
考虑到等待延迟执行任务的线程无需都使用timed waiting等待队首任务，一个task的执行线程只有一个，全部唤醒只会造成大量无效的线程唤醒和阻塞操作。
</p>


<p>
ScheduledThreadPool采用了Leader-Follower模式，等待第一个线程的任务也称为leader，其调用available.awaitNanos待当前队列头部任务到达调度时间时唤醒。
其余线程作为follower只需调用await方法无限阻塞等待，直至被leader唤醒，并重新完成抢锁-&gt;尝试执行队列首元素-&gt;抢leader-&gt;等待的循环。
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">RunnableScheduledFuture</span><span style="color: #4f97d7;">&lt;</span>?<span style="color: #4f97d7;">&gt;</span> <span style="color: #bc6ec5; font-weight: bold;">take</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">InterruptedException</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">ReentrantLock</span> <span style="color: #7590db;">lock</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.lock;
    lock.lockInterruptibly<span style="color: #bc6ec5;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>;;<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #ce537a; font-weight: bold;">RunnableScheduledFuture</span><span style="color: #67b11d;">&lt;</span>?<span style="color: #67b11d;">&gt;</span> <span style="color: #7590db;">first</span> = queue<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>first == <span style="color: #a45bad;">null</span><span style="color: #67b11d;">)</span>
                available.await<span style="color: #67b11d;">()</span>;
            <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">delay</span> = first.getDelay<span style="color: #b1951d;">(</span>NANOSECONDS<span style="color: #b1951d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span>delay &lt;= <span style="color: #a45bad;">0L</span><span style="color: #b1951d;">)</span>
                    <span style="color: #4f97d7; font-weight: bold;">return</span> finishPoll<span style="color: #b1951d;">(</span>first<span style="color: #b1951d;">)</span>;
                first = <span style="color: #a45bad;">null</span>; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">don't retain ref while waiting</span>
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span>leader != <span style="color: #a45bad;">null</span><span style="color: #b1951d;">)</span>
                    available.await<span style="color: #b1951d;">()</span>;
                <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #b1951d;">{</span>
                    <span style="color: #ce537a; font-weight: bold;">Thread</span> <span style="color: #7590db;">thisThread</span> = Thread.currentThread<span style="color: #4f97d7;">()</span>;
                    leader = thisThread;
                    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #4f97d7;">{</span>
                        available.awaitNanos<span style="color: #bc6ec5;">(</span>delay<span style="color: #bc6ec5;">)</span>;
                    <span style="color: #4f97d7;">}</span> <span style="color: #4f97d7; font-weight: bold;">finally</span> <span style="color: #4f97d7;">{</span>
                        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>leader == thisThread<span style="color: #bc6ec5;">)</span>
                            leader = <span style="color: #a45bad;">null</span>;
                    <span style="color: #4f97d7;">}</span>
                <span style="color: #b1951d;">}</span>
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">finally</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>leader == <span style="color: #a45bad;">null</span> &amp;&amp; queue<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span> != <span style="color: #a45bad;">null</span><span style="color: #2d9574;">)</span>
            available.signal<span style="color: #2d9574;">()</span>;
        lock.unlock<span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
若新增元素位于堆顶，此时需安排等待该元素定期调度或立即执行的leader线程。
为此offer方法在新增元素应率先调度时，清空leader，并signal唤醒某个等待线程，继续take方法中的循环:抢锁-&gt;尝试执行队首元素-&gt;抢leader-&gt;等待。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">offer</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">Runnable</span> <span style="color: #7590db;">x</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">ReentrantLock</span> <span style="color: #7590db;">lock</span> = <span style="color: #4f97d7; font-weight: bold;">this</span>.lock;
    lock.lock<span style="color: #bc6ec5;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;">        insert into queue</span>
<span style="color: #2aa1ae; background-color: #292e34;">        */</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>queue<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span> == e<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            leader = <span style="color: #a45bad;">null</span>;
            available.signal<span style="color: #67b11d;">()</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">finally</span> <span style="color: #bc6ec5;">{</span>
        lock.unlock<span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">true</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://summerisgreen.com/blog/2019-12-01-2019-12-01-es查询性能优化-优先选择keyword类型.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/author.png">
      <meta itemprop="name" content="Green">
      <meta itemprop="description" content="Abracadabra">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Summer is Green">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019-12-01-2019-12-01-es查询性能优化-优先选择keyword类型.html" class="post-title-link" itemprop="url">ES查询性能优化-优先选择keyword类型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-01 00:00:00" itemprop="dateCreated datePublished" datetime="2019-12-01T00:00:00+08:00">2019-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-06 00:51:25" itemprop="dateModified" datetime="2019-12-06T00:51:25+08:00">2019-12-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>
线上一个es查询越來越慢，而且cpu使用率也越來越高，逼近了比较危险的60%。
在公司的es专家帮忙profile了慢查询后，发现大量时间开销花在一个只有0和1两种取值的int型字段term查询上(build_scorer耗时非常高)，让我们把不需要数学计算及范围查询的数值类型都改为keyword。
</p>

<p>
完成字段类型修改后，我们还针对过滤后集合较小的场景使用了map的聚合数据结构，果然性能从之前的300ms提升到20ms,并且cpu使用率也降到了5%以下，可以说效果非常显著。
这也带来了一个疑惑，es的索引字段类型keyword和number为何性能会相差如此之多。
</p>
<div id="outline-container-org8474fd1" class="outline-2">
<h2 id="org8474fd1">优先使用keyword而不是number</h2>
<div class="outline-text-2" id="text-org8474fd1">
<p>
由于从es 5.x开始，其使用了block k-d tree作为数值型字段的数据结构, 而不再是倒排索引,
number和keyword查询适用范围也发生了很多差别，关于两者的具体，<a href="https://elasticsearch.cn/article/446" target="_blank" rel="noopener">wood大叔的一篇文章</a>讲的非常透彻。 
</p>

<p>
对于不关心细节的使用者来说，只要把握如下两个原则即可:
</p>
<ul class="org-ul">
<li>对于不需要范围查询和数值比较的字段，尽可能用keyword</li>
<li>如果profile发现，大量时间开销将花费在build_scorer上，可以考虑下是否有number型字段需要替换成keyword</li>
</ul>

<p>
keyword和number底层数据结构的区别以及适用的查询方式如下表所示:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="org-left">
</colgroup>

<colgroup>
<col class="org-left">
</colgroup>

<colgroup>
<col class="org-left">
</colgroup>

<colgroup>
<col class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">字段类型</th>
<th scope="col" class="org-left">数据结构</th>
<th scope="col" class="org-left">已有起始集合的term查询</th>
<th scope="col" class="org-left">range查询</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">keyword</td>
<td class="org-left">倒排索引</td>
<td class="org-left">利用跳表快速定位docid</td>
<td class="org-left">区间内所有枚举值的term查询结果的合并(OR)</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">number</td>
<td class="org-left">Block k-d tree</td>
<td class="org-left">PointRangeQuery:满足条件的docid构建bitset</td>
<td class="org-left">获取叶节点上的所有docid，扫描并和range范围比较</td>
</tr>
</tbody>
</table>

<p>
通过观察上述表格，解释了为何一个只有0和1两种取值的int型字段term查询非常慢:该term查询筛选出的集合非常之大，以至于光是构造bitset都非常耗时。
而将该类型转化为keyword后，在代价低的查询构造完迭代器后，其可以利用跳表快速判断迭代器中的docid是否满足要求。
</p>

<p>
由于存在当rangeQuery的结果集巨大，而你却要为了验证少数几个docid是否存在，而不得不遍历整个结果集的问题，es 5.4引入了<a href="https://www.elastic.co/cn/blog/better-query-planning-for-range-queries-in-elasticsearch" target="_blank" rel="noopener">indexOrDocValuesQuery</a>。
其对于遍历整个结果集的顺序访问场景，使用原有的PointRangeQuery。而对于仅仅验证少部分结果是否存在的随即访问场景,其将采用新引入的SortedSetDocValuesRangeQuery:
从代价更低的query构造出的迭代器中，依次取出doc id并去磁盘(随机访问)匹配value。
</p>
</div>
</div>
<div id="outline-container-orga69abc6" class="outline-2">
<h2 id="orga69abc6">为何聚合依旧很慢</h2>
<div class="outline-text-2" id="text-orga69abc6">
<p>
当将能改成keyword的索引字段都改成keyword后，发现个很神奇的现象，
一个query第一次查询时甚至比优化前慢多了达到秒级别，但多尝试几次后又很快，达到20多ms。
经过对查询条件进行多次调整尝试，发现上述问题是对区分度较高的keyword字段(原先为数值型)进行聚合而导致的。
</p>

<p>
<a href="https://www.elastic.co/cn/blog/improving-the-performance-of-high-cardinality-terms-aggregations-in-elasticsearch" target="_blank" rel="noopener">查询资料</a>后了解到，ES默认聚合采用global ordinals的数据结构对聚合字段进行bucket分组，其适合包含的原始文档非常多的情况。
但当新数据刷入后的查询需要重建global ordinals数据结构，此时将会产生慢查询，并且重建时间随着区分度的增加而增加。
可通过<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/eager-global-ordinals.html" target="_blank" rel="noopener">enable eager global ordinals</a>,让其在segments更新时自动更新全局global ordinals，从而保证查询稳定性。
</p>

<p>
在我们的场景中，由于terms过滤后只剩少量文档需要聚合，可以采用直接在内存map中进行聚合的方案。
可以设置execution_hint:map达到此效果。不过在6.7版本前，由于存在bug，需要将查询语句改写成script才能走map的聚合计划。具体可参考如下示例。
</p>
<pre class="example">
"aggregations" : {
    "top-ibans" : {
         "terms" : {
             "script": {
                 "source" : "doc['IBAN_keyword'].value",
                 "lang" : "painless"
             }
         }
     }
}
</pre>
</div>
</div>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://summerisgreen.com/blog/2019-03-03-2019-03-03-futuretask中的状态机.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/author.png">
      <meta itemprop="name" content="Green">
      <meta itemprop="description" content="Abracadabra">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Summer is Green">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019-03-03-2019-03-03-futuretask中的状态机.html" class="post-title-link" itemprop="url">FutureTask源码简析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-03 00:00:00" itemprop="dateCreated datePublished" datetime="2019-03-03T00:00:00+08:00">2019-03-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-01 23:10:27" itemprop="dateModified" datetime="2019-12-01T23:10:27+08:00">2019-12-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>
由于FutureTask可能在多个线程中触发执行或者取消逻辑,如果没有线程安全保证，
可能会出现执行已取消操作，异步操作被多次执行等违反Futuretask语义的情形。
为了保证FutureTask的线程安全，jdk结合使用了状态机和cas操作。
</p>
<div id="outline-container-org51394a9" class="outline-2">
<h2 id="org51394a9">FutureTask中的状态机</h2>
<div class="outline-text-2" id="text-org51394a9">
</div>
<div id="outline-container-org688eae3" class="outline-3">
<h3 id="org688eae3">状态机设计</h3>
<div class="outline-text-3" id="text-org688eae3">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">NEW</span>          = <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">COMPLETING</span>   = <span style="color: #a45bad;">1</span>;
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">NORMAL</span>       = <span style="color: #a45bad;">2</span>;
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">EXCEPTIONAL</span>  = <span style="color: #a45bad;">3</span>;
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">CANCELLED</span>    = <span style="color: #a45bad;">4</span>;
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">INTERRUPTING</span> = <span style="color: #a45bad;">5</span>;
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">INTERRUPTED</span>  = <span style="color: #a45bad;">6</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf2f2d74" class="outline-3">
<h3 id="orgf2f2d74">状态的变化</h3>
<div class="outline-text-3" id="text-orgf2f2d74">
<p>
在FutureTask中，一共存在上面所述7种状态，其中New为实例的初始化状态，
Completing和Interrupting为中间状态，其余四个为最终状态。
</p>
<ul class="org-ul">
<li>New-&gt;Completing-&gt;Normal</li>
<li>New-&gt;Completing-&gt;Exceptional</li>
<li>New-&gt;Cancelled</li>
<li>New-&gt;Interrupting-&gt;Interrupted</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org07fb37f" class="outline-2">
<h2 id="org07fb37f">并发问题的解决</h2>
<div class="outline-text-2" id="text-org07fb37f">
</div>
<div id="outline-container-org8302213" class="outline-3">
<h3 id="org8302213">争夺状态改变权</h3>
<div class="outline-text-3" id="text-org8302213">
<p>
对于初始化状态New，正如之前看到的，其可能有四种状态演化的方式，
而这四种状态演化方式主要是通过调用cancel,set和setException三个方法来获得的。
</p>
<ul class="org-ul">
<li>cancel操作: New-&gt;Interrupting-&gt;Interrupted</li>
<li>cancel操作: New-&gt;Cancel</li>
<li>set操作: New-&gt;Completing-&gt;Normal</li>
<li>setException操作: New-&gt;Completing-&gt;Exceptional</li>
</ul>

<p>
由于对FutureTask实例存在cancel,set,setException操作的并发调用，
为了避免状态演化的混乱，这三种方法均采用cas操作来争夺唯一的状态改变权。
表现在源码中，这几个方法都通过调用STATE.compareAndSet来试图获取状态控制权。
当获取到状态控制权之后，表面该线程是唯一修改状态变量的线程，
因此可以直接继续操作状态值(比如set方法中:STATE.setRelease(this, NORMAL))，而无需再使用对性能有消耗的cas操作了。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">set</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">V</span> <span style="color: #7590db;">v</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>STATE.compareAndSet<span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>, NEW, COMPLETING<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        outcome = v;
        STATE.setRelease<span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>, NORMAL<span style="color: #2d9574;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">final state</span>
        finishCompletion<span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #bc6ec5; font-weight: bold;">cancel</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">mayInterruptIfRunning</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">!</span><span style="color: #2d9574;">(</span>state == NEW &amp;&amp; STATE.compareAndSet
          <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>, NEW, mayInterruptIfRunning ? INTERRUPTING : CANCELLED<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">false</span>;
    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #bc6ec5;">{</span>    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">in case call to interrupt throws exception</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>mayInterruptIfRunning<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #67b11d;">{</span>
                <span style="color: #ce537a; font-weight: bold;">Thread</span> <span style="color: #7590db;">t</span> = runner;
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span>t != <span style="color: #a45bad;">null</span><span style="color: #b1951d;">)</span>
                    t.interrupt<span style="color: #b1951d;">()</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">finally</span> <span style="color: #67b11d;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">final state</span>
                STATE.setRelease<span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>, INTERRUPTED<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">finally</span> <span style="color: #bc6ec5;">{</span>
        finishCompletion<span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">true</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org70ca8b1" class="outline-3">
<h3 id="org70ca8b1">状态码判断</h3>
<div class="outline-text-3" id="text-org70ca8b1">
<p>
FutureTask中状态机设计的比较巧妙的一点就是:可以基于状态码的值来快速决定下一步的行动。
比如在get方法中，通过比较当前状态和COMPLETING值，来决定是继续等待完成还是调用report方法返回结果。
对后者，通过将状态值与NORMAL以及CANCEL值比较，得出最终结果或异常类型。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">V</span> <span style="color: #bc6ec5; font-weight: bold;">get</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">InterruptedException</span>, <span style="color: #ce537a; font-weight: bold;">ExecutionException</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">s</span> = state;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>s &lt;= COMPLETING<span style="color: #bc6ec5;">)</span>
        s = awaitDone<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">false</span>, <span style="color: #a45bad;">0L</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> report<span style="color: #bc6ec5;">(</span>s<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">V</span> <span style="color: #bc6ec5; font-weight: bold;">report</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">s</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">ExecutionException</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">Object</span> <span style="color: #7590db;">x</span> = outcome;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>s == NORMAL<span style="color: #bc6ec5;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">V</span><span style="color: #bc6ec5;">)</span>x;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>s &gt;= CANCELLED<span style="color: #bc6ec5;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">CancellationException</span><span style="color: #bc6ec5;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ExecutionException</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">Throwable</span><span style="color: #2d9574;">)</span>x<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org4f52837" class="outline-3">
<h3 id="org4f52837">任务执行</h3>
<div class="outline-text-3" id="text-org4f52837">
<p>
FutureTask中最重要的方法莫过于run方法了，毕竟FutureTask的核心就是异步执行了。
在很多情况下提交的Futuretask任务为耗时任务，在该任务执行前或执行过程中极有可能由于各种原因被取消。
因此在run方法的finally中需要进行状态机判断,如果该任务已被取消,需要让出当前线程，等完成取消任务后再继续执行。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">run</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>state != NEW ||
        <span style="color: #a45bad;">!</span>RUNNER.compareAndSet<span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>, <span style="color: #a45bad;">null</span>, Thread.currentThread<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span>;
    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #ce537a; font-weight: bold;">Callable</span><span style="color: #2d9574;">&lt;</span><span style="color: #ce537a; font-weight: bold;">V</span><span style="color: #2d9574;">&gt;</span> <span style="color: #7590db;">c</span> = callable;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>c != <span style="color: #a45bad;">null</span> &amp;&amp; state == NEW<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #ce537a; font-weight: bold;">V</span> <span style="color: #7590db;">result</span>;
            <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">ran</span>;
            <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #67b11d;">{</span>
                result = c.call<span style="color: #b1951d;">()</span>;
                ran = <span style="color: #a45bad;">true</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">Throwable</span> <span style="color: #7590db;">ex</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                result = <span style="color: #a45bad;">null</span>;
                ran = <span style="color: #a45bad;">false</span>;
                setException<span style="color: #b1951d;">(</span>ex<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>ran<span style="color: #67b11d;">)</span>
                set<span style="color: #67b11d;">(</span>result<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">finally</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">runner must be non-null until state is settled to</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">prevent concurrent calls to run()</span>
        runner = <span style="color: #a45bad;">null</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">state must be re-read after nulling runner to prevent</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">leaked interrupts</span>
        <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">s</span> = state;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>s &gt;= INTERRUPTING<span style="color: #2d9574;">)</span>
            handlePossibleCancellationInterrupt<span style="color: #2d9574;">(</span>s<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">handlePossibleCancellationInterrupt</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">s</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>s == INTERRUPTING<span style="color: #bc6ec5;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>state == INTERRUPTING<span style="color: #bc6ec5;">)</span>
            Thread.yield<span style="color: #bc6ec5;">()</span>; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">wait out pending interrupt</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
值得注意的是，在任务结束后，futuretask类只保留了最终的状态及结果(正确值或异常)，
而执行线程信息以及callable回调函数等对象都因不再有用而置null,以便及时被gc回收。
</p>
</div>
</div>
<div id="outline-container-org06ae1bb" class="outline-3">
<h3 id="org06ae1bb">结果等待</h3>
<div class="outline-text-3" id="text-org06ae1bb">
<p>
当用户代码向线程池提交任务后，一个最常见的后续操作就是阻塞(或带超时的阻塞)等待任务结果
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">V</span> <span style="color: #bc6ec5; font-weight: bold;">get</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">InterruptedException</span>, <span style="color: #ce537a; font-weight: bold;">ExecutionException</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">s</span> = state;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>s &lt;= COMPLETING<span style="color: #bc6ec5;">)</span>
        s = awaitDone<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">false</span>, <span style="color: #a45bad;">0L</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> report<span style="color: #bc6ec5;">(</span>s<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">V</span> <span style="color: #bc6ec5; font-weight: bold;">get</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">timeout</span>, <span style="color: #ce537a; font-weight: bold;">TimeUnit</span> <span style="color: #7590db;">unit</span><span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">InterruptedException</span>, <span style="color: #ce537a; font-weight: bold;">ExecutionException</span>, <span style="color: #ce537a; font-weight: bold;">TimeoutException</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>unit == <span style="color: #a45bad;">null</span><span style="color: #bc6ec5;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">NullPointerException</span><span style="color: #bc6ec5;">()</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">s</span> = state;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>s &lt;= COMPLETING &amp;&amp;
        <span style="color: #2d9574;">(</span>s = awaitDone<span style="color: #67b11d;">(</span><span style="color: #a45bad;">true</span>, unit.toNanos<span style="color: #b1951d;">(</span>timeout<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt;= COMPLETING<span style="color: #bc6ec5;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">TimeoutException</span><span style="color: #bc6ec5;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> report<span style="color: #bc6ec5;">(</span>s<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
如果此时任务还未完成，其将调用awaitDone方法，利用cas加入队列后，使用park/parkNanos方法阻塞线程，直至被唤醒。
其将在下面三种情况下被唤醒:
1.线程被中断
2.超时阻塞已超时
3.完成任务结果及状态记录(正确值或异常结果更新)
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">awaitDone</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">timed</span>, <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">nanos</span><span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">InterruptedException</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">final</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">deadline</span> = timed ? System.nanoTime<span style="color: #bc6ec5;">()</span> + nanos : <span style="color: #a45bad;">0L</span>;
    <span style="color: #ce537a; font-weight: bold;">WaitNode</span> <span style="color: #7590db;">q</span> = <span style="color: #a45bad;">null</span>;
    <span style="color: #ce537a; font-weight: bold;">boolean</span> <span style="color: #7590db;">queued</span> = <span style="color: #a45bad;">false</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>Thread.interrupted<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            removeWaiter<span style="color: #67b11d;">(</span>q<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">InterruptedException</span><span style="color: #67b11d;">()</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">s</span> = state;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>s &gt; COMPLETING<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>q != <span style="color: #a45bad;">null</span><span style="color: #67b11d;">)</span>
                q.thread = <span style="color: #a45bad;">null</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> s;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>s == COMPLETING<span style="color: #2d9574;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">cannot time out yet</span>
            Thread.yield<span style="color: #2d9574;">()</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>q == <span style="color: #a45bad;">null</span><span style="color: #2d9574;">)</span>
            q = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">WaitNode</span><span style="color: #2d9574;">()</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #a45bad;">!</span>queued<span style="color: #2d9574;">)</span>
            queued = UNSAFE.compareAndSwapObject<span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>, waitersOffset,
                                                 q.next = waiters, q<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>timed<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            nanos = deadline - System.nanoTime<span style="color: #67b11d;">()</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>nanos &lt;= <span style="color: #a45bad;">0L</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                removeWaiter<span style="color: #b1951d;">(</span>q<span style="color: #b1951d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">return</span> state;
            <span style="color: #67b11d;">}</span>
            LockSupport.parkNanos<span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span>, nanos<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span>
            LockSupport.park<span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">this</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
</div>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://summerisgreen.com/blog/2018-04-24-2018-04-23-hadoop中mapper和reducer个数的设置.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/author.png">
      <meta itemprop="name" content="Green">
      <meta itemprop="description" content="Abracadabra">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Summer is Green">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2018-04-24-2018-04-23-hadoop中mapper和reducer个数的设置.html" class="post-title-link" itemprop="url">Hadoop中的Mapper和Reducer数量设定</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-24 00:00:00" itemprop="dateCreated datePublished" datetime="2018-04-24T00:00:00+08:00">2018-04-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-03-15 07:44:27" itemprop="dateModified" datetime="2019-03-15T07:44:27+08:00">2019-03-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>
对于大数据处理，特别是T级别以上的海量数据，
由于数据量大大超过了单机运算能力，需要通过分布式的方法来对数据进行处理。
Hadoop作为大数据领域的明星项目，提供了MapReduce分布式编程框架,
其基于分而治冶的思想，将海量数据拆分为大量的小数据块，从而在多个节点并行处理海量数据。
</p>

<p>
虽然MapReduce通过分布式计算、map端"数据本地化优化“等不同层次的策略来提升数据处理任务的执行效率，
但由于实际处理的数据量较大，一个典型的MapReduce作业往往需要花费数分钟到数小时来完成。
并且在任务执行的过程中，MapReduce作业还将占用大量的网络带宽和计算资源，从而降低了整个集群的计算能力。
为了进一步提升MapReduce的执行效率，需要对MapReduce任务进行调优。
而最为直接有效的一种调优方式就是调整Mapper和Reducer的数量。
</p>

<div id="outline-container-org822556c" class="outline-2">
<h2 id="org822556c">Mapper的数量设定</h2>
<div class="outline-text-2" id="text-org822556c">
<p>
在对Mapper调优的过程中，一个经验法则是：
map任务最好拥有一分钟以上的运行时间。
因为如果任务运行时间过短，将导致在整个作业的执行过程中任务启动所花费的时间过大，从而降低了实际的任务执行效率。
对map任务的运行时间影响最大的是Mapper的个数，不过与Reducer不同，Mapper的个数是无法显示指定的。
调节Mapper数量的一种方式是设置参数mapred.jobtracker.maxtasks.per.job，
但其只能限制每个job中并发运行的map或reduce任务的上限，而当实际运行的map数低于该上限时，该参数将失效。
如果想要对Mapper个数进行更加直接有效的控制，需要指定输入数据的分片大小。
</p>

<p>
输入分片(input split)是MapReduce框架为使map任务能并行处理海量数据记录，
为每个map任务单独划分的一个等长小数据块。
在MapReduce框架中，输入数据分片通过InputFormat接口完成。
为方便程序员使用，Hadoop为最常见的文件数据源提供了大量基于FileInputFormat基类的实现类。
因此只要掌握了FileInputFormat的数据分片原理，也就知道了各种常见的数据源实现类是如何进行数据分片的了。
</p>

<p>
FileInputFormat提供了三个属性参数来控制实际的分片大小：mapreduce.input.fileinputformat.split.minsize, mapreduce.input.fileinputformat.split.maxsize以及dfs.blocksize。
这三个参数分别表示一个文件分片最小的有效字节数、最大字节数以及HDFS中块的大小。
利用公式splitSize = max(minimumSize, min(maximumSize, blockSize))，可以通过改变上述三个参数来调节最终的分片大小。
在调节分片大小时需要防止分片切分过小，避免管理分片和构建map任务的时间在整个任务运行周期中占比过大。
但分片划分也不是越大越好，至少不应大于块大小，因为那时将无法确保存储有该切片的多个数据块位于单个节点中，从而增加了执行map任务时的网络传输。
因此对于大多数作业来说，一个合理的分片大小趋向于HDFS的一个块的大小，默认是128MB。
</p>

<p>
需要注意的是，虽然输入分片划分是本着尽量拆分成等长数据块的原则，但最后的分片大小并不完全一致。
因为数据分片对有效字节数小于maximumSize的文件并不进行拆分，而且进行拆分的大文件的大小往往不会为文件块大小的整数倍。
分片大小与指向分片数据的引用一起包含在输入分片中，供application master调度使用。
在调度的过程中，Hadoop通过优先处理最大的分片以最小化实际运行时间。
</p>
</div>
</div>

<div id="outline-container-org1dd2598" class="outline-2">
<h2 id="org1dd2598">Reducer的数量设定</h2>
<div class="outline-text-2" id="text-org1dd2598">
<p>
Reducer的个数是由用户独立设置的，在默认情况下只有一个Reducer。
它的个数既可以使用命令行参数设置（mapreduce.job.reduces=number），也可以在程序中制定（job.setNumReduceTasks(number)）。
</p>

<p>
为了更加高效地完成reduce任务，Reducer的个数需要依据自己的任务特点和机器负载情况进行选择。
Hadoop权威指南给出的一条经验法则是：目标Reducer保持在每个运行5分钟左右，且产生至少一个HDFS块的输出。
而Apache的MapReduce官方教程中给出的建议是：Reducer个数应该设置为0.95或者1.75乘以节点数与每个节点的容器数的乘积。
当乘数为0.95时，map任务结束后所有的reduce将会立刻启动并开始转移数据，
此时队列中无等待任务，该设置适合reudce任务执行时间短或者reduce任务在个节点的执行时间相差不大的情况；
当乘数为1.75时，运行较快的节点将在完成第一轮reduce任务后，可以立即从队列中取出新的reduce任务执行，
由于该reduce个数设置方法减轻了单个reduce任务的负载，并且运行较快的节点将执行新的reduce任务而非空等执行较慢的节点，其拥有更好的负载均衡特性。
</p>
</div>
</div>

<div id="outline-container-orgb4af80d" class="outline-2">
<h2 id="orgb4af80d">参考</h2>
<div class="outline-text-2" id="text-orgb4af80d">
<p>
<a href="https://book.douban.com/subject/27115351/" target="_blank" rel="noopener">Hadoop权威指南</a>
</p>

<p>
<a href="https://hadoop.apache.org/docs/current/hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduceTutorial.html#Reducer" target="_blank" rel="noopener">MapReduce Tutorial</a>
</p>

<p>
<a href="https://stackoverflow.com/questions/21980110/what-is-ideal-number-of-reducers-on-hadoop" target="_blank" rel="noopener">What is Ideal number of reducers on Hadoop?</a>
</p>

<p>
<a href="https://stackoverflow.com/questions/20818370/how-to-set-the-number-of-mappers-in-new-hadoop-api" target="_blank" rel="noopener">How to set the number of mappers in new Hadoop api?</a>
</p>
</div>
</div>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://summerisgreen.com/blog/2017-07-28-2017-07-28-算法技巧-使用动态规划求解部分和问题.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/author.png">
      <meta itemprop="name" content="Green">
      <meta itemprop="description" content="Abracadabra">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Summer is Green">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2017-07-28-2017-07-28-算法技巧-使用动态规划求解部分和问题.html" class="post-title-link" itemprop="url">算法技巧-使用动态规划求解部分和问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-28 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-28T00:00:00+08:00">2017-07-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-03-15 07:44:29" itemprop="dateModified" datetime="2019-03-15T07:44:29+08:00">2019-03-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程技巧/" itemprop="url" rel="index"><span itemprop="name">编程技巧</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
<div id="outline-container-org58b574a" class="outline-2">
<h2 id="org58b574a">部分和问题</h2>
<div class="outline-text-2" id="text-org58b574a">
<p>
在算法中，有一类常见的问题被称为部分和问题。
在这类问题中，你需要判断是否能够使用给定数组中的部分数，通过累加获得所要获得的目标和。
而对于每个候选数字，在有些题目中你只能使用一次，而在另一些题目中则可以多次使用。
在后面我们会看到，这两种情况都可以使用动态规划方法来求解，只不过具体的求解思路会有一些不同。
</p>
</div>
</div>
<div id="outline-container-orgb0ee185" class="outline-2">
<h2 id="orgb0ee185">Partition Equal Subset Sum</h2>
<div class="outline-text-2" id="text-orgb0ee185">
<pre class="example">
Given a non-empty array containing only positive integers, find if the array can be partitioned into two subsets such that the sum of elements in both subsets is equal.
</pre>

<p>
为了解决这个问题，首先假设我们将集合 nums 分成了满足条件的 A 和 B 这两个子集合，它们必然满足下面两个条件：
</p>

<p>
sum(A) = sum(B)
sum(A) + sum(B) = sum(nums)
</p>

<p>
使用前一个公式将后一个等式中的B替换为A，可得：
</p>

<p>
sum(A) = sum(nums)/2 
</p>

<p>
我们可以发现，这道题已经转化成了我们之前所讨论的部分和的问题了。
</p>

<p>
现在我们所要求解的是：是否能够从一个给定的数的集合选出一个子集合，这个子集合中元素的和为该集合中全部元素和的一半。
当然如果整个集合中所有元素的和为奇数的话，这个子集合肯定不存在。可以对这个条件提前进行判断，以减少不必要的计算。
</p>

<p>
如果整个集合中所有元素的和的一半为偶数的话，就需要使用动态规划方法来判断是否能够找到这样的子集合。
为了使用动态规划方法，我们构造了一个数组称为 oldp，其表示对于已经遍历过的数字，是否能在它们中找到所有元素的和等于该索引值的子集合。
</p>
<ul class="org-ul">
<li>初始化：在第一次迭代之前，只有索引为0的位置的值为True，其余均为False，条件为真。</li>
<li>保持：当遍历第i个数时，当且仅当j之前就能被部分和所表示或者j-i能被表示时，该遍历完成后j能被表示。</li>
<li>终止：oldp 中各个索引的值表示是否能用所给的数组的部分和来表示。</li>
</ul>

<p>
因此在完成所有数值的循环后，只需要查看索引为 half 的 oldp 即可知道是否能将整个数组分为两个元素和相等的集合。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">canPartition</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>, nums<span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae;">"""</span>
<span style="color: #2aa1ae;">    :type nums: List[int]</span>
<span style="color: #2aa1ae;">    :rtype: bool</span>
<span style="color: #2aa1ae;">    """</span>
    <span style="color: #7590db;">sums</span> = <span style="color: #4f97d7;">sum</span><span style="color: #4f97d7;">(</span>nums<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> sums % <span style="color: #a45bad;">2</span> == <span style="color: #a45bad;">1</span>:
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">False</span>

    <span style="color: #7590db;">half</span> = sums / <span style="color: #a45bad;">2</span>
    <span style="color: #7590db;">oldp</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">False</span><span style="color: #4f97d7;">]</span> * <span style="color: #4f97d7;">(</span>half + <span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">oldp</span><span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">True</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> nums:
        <span style="color: #4f97d7; font-weight: bold;">for</span> j <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span>half, i-<span style="color: #a45bad;">1</span>, -<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>:
            <span style="color: #7590db;">oldp</span><span style="color: #4f97d7;">[</span>j<span style="color: #4f97d7;">]</span> = oldp<span style="color: #4f97d7;">[</span>j<span style="color: #4f97d7;">]</span> <span style="color: #4f97d7; font-weight: bold;">or</span> oldp<span style="color: #4f97d7;">[</span>j-i<span style="color: #4f97d7;">]</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> oldp<span style="color: #4f97d7;">[</span>half<span style="color: #4f97d7;">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org8bd4520" class="outline-2">
<h2 id="org8bd4520">Target Sum</h2>
<div class="outline-text-2" id="text-org8bd4520">
<pre class="example">
 You are given a list of non-negative integers, a1, a2, ..., an, and a target, S. Now you have 2 symbols + and -. For each integer, you should choose one from + and - as its new symbol.

Find out how many ways to assign symbols to make sum of integers equal to target S. 
</pre>

<p>
这道题目看起来和上一个题目相差很大，但是如果我们对题目所给的条件做一些适当的数学变化的话，
就会发现这道题目本质上也是个部分和的问题。
</p>

<p>
首先我们假设在这个集合中，正的子集合为P，负的为N。
然后我们就可以使用这两个符号将题目所包含的关系给表示出来：
</p>

<p>
sum(P) + sum(N) = sum(nums)
</p>

<p>
sum(P) - sum(N) = S
</p>

<p>
将这两个等式组合一下之后，我们可以发现该问题已经转换为部分和的问题了:
</p>

<p>
sum(P) = (sum(nums) + S)/2
</p>

<p>
这里一个比较大的不同就是：这个问题所求的是有多少种不同的部分和的结果和目标值相同，而上一题仅仅需要知道是否存在和目标值的部分和。
所以在这里，我们的 dp 表示的是存在多少种不同的部分和可以表示该索引值，此时的内层递推公式也相应的改成了:
</p>

<p>
dp[j] += dp[j-1]
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">findTargetSumWays</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>, nums, S<span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae;">"""</span>
<span style="color: #2aa1ae;">    :type nums: List[int]</span>
<span style="color: #2aa1ae;">    :type S: int</span>
<span style="color: #2aa1ae;">    :rtype: int</span>
<span style="color: #2aa1ae;">    """</span>
    <span style="color: #7590db;">target</span> = <span style="color: #4f97d7;">sum</span><span style="color: #4f97d7;">(</span>nums<span style="color: #4f97d7;">)</span> + S
    <span style="color: #4f97d7; font-weight: bold;">if</span> S &gt; <span style="color: #4f97d7;">sum</span><span style="color: #4f97d7;">(</span>nums<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7; font-weight: bold;">or</span> target % <span style="color: #a45bad;">2</span>:
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>
    <span style="color: #4f97d7; font-weight: bold;">else</span>:
        <span style="color: #7590db;">target</span> = target/<span style="color: #a45bad;">2</span>

    <span style="color: #7590db;">dp</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span> * <span style="color: #4f97d7;">(</span>target+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">dp</span><span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">1</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> nums:
        <span style="color: #4f97d7; font-weight: bold;">for</span> j <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">reversed</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">range</span><span style="color: #bc6ec5;">(</span>i, target+<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>:
            <span style="color: #7590db;">dp</span><span style="color: #4f97d7;">[</span>j<span style="color: #4f97d7;">]</span> += dp<span style="color: #4f97d7;">[</span>j-i<span style="color: #4f97d7;">]</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> dp<span style="color: #4f97d7;">[</span>target<span style="color: #4f97d7;">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf2a13b6" class="outline-2">
<h2 id="orgf2a13b6">Combination Sum IV</h2>
<div class="outline-text-2" id="text-orgf2a13b6">
<pre class="example">
Given an integer array with all positive numbers and no duplicates, find the number of possible combinations that add up to a positive integer target.
</pre>

<p>
需要注意的是，在这个题目中数组中的每个数字都可以使用多次，而不是像之前的题目所要求的只能使用一次。
为了能够满足这个条件，我们可以从1开始一直到目标值，依次尝试是否能够使用数组中的数来累加到所尝试的索引值。
因为数组中的数是大于等于1的，而我们对部分和目标值的搜索跨度为1，所以使用这种方法必定是不会错过数组集合中所有数值的任何一种可能的组合的。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">combinationSum4</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>, nums, target<span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae;">"""</span>
<span style="color: #2aa1ae;">    :type nums: List[int]</span>
<span style="color: #2aa1ae;">    :type target: int</span>
<span style="color: #2aa1ae;">    :rtype: int</span>
<span style="color: #2aa1ae;">    """</span>
    <span style="color: #7590db;">d</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span> * <span style="color: #4f97d7;">(</span>target+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">d</span><span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">1</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1</span>,target+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">for</span> j <span style="color: #4f97d7; font-weight: bold;">in</span> nums:
            <span style="color: #4f97d7; font-weight: bold;">if</span> i &gt;= j:
                <span style="color: #7590db;">d</span><span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span> += d<span style="color: #4f97d7;">[</span>i-j<span style="color: #4f97d7;">]</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> d<span style="color: #4f97d7;">[</span>target<span style="color: #4f97d7;">]</span>
</pre>
</div>
</div>
</div>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://summerisgreen.com/blog/2017-07-27-2017-07-27-算法技巧-使用动态规划解决地图路径类问题.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/author.png">
      <meta itemprop="name" content="Green">
      <meta itemprop="description" content="Abracadabra">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Summer is Green">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2017-07-27-2017-07-27-算法技巧-使用动态规划解决地图路径类问题.html" class="post-title-link" itemprop="url">算法技巧-使用动态规划解决地图路径类问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-27 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-27T00:00:00+08:00">2017-07-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-03-15 07:44:26" itemprop="dateModified" datetime="2019-03-15T07:44:26+08:00">2019-03-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程技巧/" itemprop="url" rel="index"><span itemprop="name">编程技巧</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
<div id="outline-container-orgb79ee36" class="outline-2">
<h2 id="orgb79ee36">栅格化的有向图类问题</h2>
<div class="outline-text-2" id="text-orgb79ee36">
<p>
对于图论的路径寻找问题，比较经典的解法就是Dijkstra 和 A*算法了。
这两种方法虽然通用，但编码实现比较复杂。
如果对这类问题中比较简单的一些问题也采用这种解法的话，就有点用大炮打蚊子的感觉了。
</p>

<p>
这里面的一类简单问题就是在栅格化了的有向图中进行搜索，因为其探索路径比较固定，一般为向右和向下，
所以可以直接使用动态规划来进行求解。
</p>

<p>
下面将结合leetcode题目来进行具体的讲解。
</p>
</div>
</div>
<div id="outline-container-orge99b09f" class="outline-2">
<h2 id="orge99b09f">Minimum Path Sum</h2>
<div class="outline-text-2" id="text-orge99b09f">
<pre class="example">
Given a m x n grid filled with non-negative numbers, find a path from top left to bottom right which minimizes the sum of all numbers along its path.
</pre>

<p>
对于最短路径问题，假设我们有一个 m*n 的cost矩阵，这个矩阵中每个点表示的是从起始点到该点的最小路径的值。
矩阵中值的迭代过程可以使用下面的公式来表示：
</p>

<p>
cost(i,j) = min(cost(i-1,j), cost(i,j-1)) + grid[i][j]。
</p>

<p>
有了这个迭代公式，我们就可以使用动态规划方法来求解这个最短路径的问题了。
</p>

<p>
在编码之前，我们通过观察可以发现，在实际计算cost时，我们只需要当前行中的前一列中的元素和前一行中当前列的元素，
因此我们实际需要的只是两个n维向量而不是 m*n 的矩阵。
我们将这两个向量命名为 pre 和 cur，它们分别表示前一行和当前行向量。
利用这两个向量，我们将之前的迭代公式转化为：
</p>

<p>
cur(j) = min(cur(j-1),pre(j)) + grid[i][j]。
</p>

<p>
在编码求解该问题的过程中，一个比较麻烦的细节就是对边界问题的处理了。
可以使用的一个技巧就是给这两个向量的头部增加一个节点作为哨兵节点。
这里将 cur 的第一个节点设置为正无穷大，保证最左端的节点只会采用从前一行过来的路径。
而第一行需要特殊处理，因为他们都只存在从左边过来的路径，这里将 pre 的第一个元素设置为0，从而保证了元素值的正确性。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">minPathSum</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>, grid<span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae;">"""</span>
<span style="color: #2aa1ae;">    :type grid: List[List[int]]</span>
<span style="color: #2aa1ae;">    :rtype: int</span>
<span style="color: #2aa1ae;">    """</span>
    <span style="color: #7590db;">height</span>, <span style="color: #7590db;">length</span> = <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>grid<span style="color: #4f97d7;">)</span>, <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>grid<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">pre</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span> * <span style="color: #4f97d7;">(</span>length+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">cur</span> = <span style="color: #4f97d7;">[</span><span style="color: #4f97d7;">float</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"inf"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">]</span> * <span style="color: #4f97d7;">(</span>length+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span>length<span style="color: #4f97d7;">)</span>:
        <span style="color: #7590db;">pre</span><span style="color: #4f97d7;">[</span>i+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span> = pre<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span> + grid<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">][</span>i<span style="color: #4f97d7;">]</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1</span>, height<span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">for</span> j <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span>length<span style="color: #4f97d7;">)</span>:
            <span style="color: #7590db;">cur</span><span style="color: #4f97d7;">[</span>j+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">min</span><span style="color: #4f97d7;">(</span>cur<span style="color: #bc6ec5;">[</span>j<span style="color: #bc6ec5;">]</span>, pre<span style="color: #bc6ec5;">[</span>j+<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> + grid<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">][</span>j<span style="color: #4f97d7;">]</span>
        <span style="color: #7590db;">pre</span> = <span style="color: #4f97d7;">[</span>i <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> cur<span style="color: #4f97d7;">]</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> pre<span style="color: #4f97d7;">[</span>length<span style="color: #4f97d7;">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org162a277" class="outline-2">
<h2 id="org162a277">Unique Paths</h2>
<div class="outline-text-2" id="text-org162a277">
<pre class="example">
A robot is located at the top-left corner of a m x n grid (marked 'Start' in the diagram below).

The robot can only move either down or right at any point in time. The robot is trying to reach the bottom-right corner of the grid (marked 'Finish' in the diagram below).

How many possible unique paths are there?
</pre>

<p>
这个问题的基本迭代公式为 paths(i,j) = paths(i-1,j) + paths(i,j-1)，其解决思路和上一题的一致，只是初始化和边界条件的设置更加简单。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">uniquePaths</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>, m, n<span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae;">"""</span>
<span style="color: #2aa1ae;">    :type m: int</span>
<span style="color: #2aa1ae;">    :type n: int</span>
<span style="color: #2aa1ae;">    :rtype: int</span>
<span style="color: #2aa1ae;">    """</span>
    <span style="color: #7590db;">pre</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span> * <span style="color: #4f97d7;">(</span>n+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">cur</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span> * <span style="color: #4f97d7;">(</span>n+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> j <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span>n<span style="color: #4f97d7;">)</span>:
        <span style="color: #7590db;">pre</span><span style="color: #4f97d7;">[</span>j+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">1</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1</span>,m<span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">for</span> j <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span>n<span style="color: #4f97d7;">)</span>:
            <span style="color: #7590db;">cur</span><span style="color: #4f97d7;">[</span>j+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span> = cur<span style="color: #4f97d7;">[</span>j<span style="color: #4f97d7;">]</span> + pre<span style="color: #4f97d7;">[</span>j+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>
        <span style="color: #7590db;">pre</span> = <span style="color: #4f97d7;">[</span>mem <span style="color: #4f97d7; font-weight: bold;">for</span> mem <span style="color: #4f97d7; font-weight: bold;">in</span> cur<span style="color: #4f97d7;">]</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> pre<span style="color: #4f97d7;">[</span>n<span style="color: #4f97d7;">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orga2cedc1" class="outline-2">
<h2 id="orga2cedc1">Unique Paths II</h2>
<div class="outline-text-2" id="text-orga2cedc1">
<pre class="example">
Follow up for "Unique Paths":

Now consider if some obstacles are added to the grids. How many unique paths would there be?

An obstacle and empty space is marked as 1 and 0 respectively in the grid.
</pre>

<p>
如果路径中是存在障碍物的话，基本思路和之前的题目依旧相同，只是要在每个迭代中加一个将障碍物点上的路径值设为0的语句即可。
具体的解法如下面的Python代码所示。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">uniquePathsWithObstacles</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>, obstacleGrid<span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae;">"""</span>
<span style="color: #2aa1ae;">    :type obstacleGrid: List[List[int]]</span>
<span style="color: #2aa1ae;">    :rtype: int</span>
<span style="color: #2aa1ae;">    """</span>
    <span style="color: #7590db;">height</span>, <span style="color: #7590db;">length</span> = <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>obstacleGrid<span style="color: #4f97d7;">)</span>, <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span>obstacleGrid<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">pre</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span> * <span style="color: #4f97d7;">(</span>length +<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">cur</span> = <span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span> * <span style="color: #4f97d7;">(</span>length +<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">pre</span><span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">1</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span>length<span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">if</span> obstacleGrid<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">][</span>i<span style="color: #4f97d7;">]</span> == <span style="color: #a45bad;">1</span>:
            <span style="color: #7590db;">pre</span><span style="color: #4f97d7;">[</span>i+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">0</span>
        <span style="color: #4f97d7; font-weight: bold;">else</span>:
            <span style="color: #7590db;">pre</span><span style="color: #4f97d7;">[</span>i+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span> = pre<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1</span>, height<span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">for</span> j <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span><span style="color: #4f97d7;">(</span>length<span style="color: #4f97d7;">)</span>:
            <span style="color: #4f97d7; font-weight: bold;">if</span> obstacleGrid<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">][</span>j<span style="color: #4f97d7;">]</span> == <span style="color: #a45bad;">1</span>:
                <span style="color: #7590db;">cur</span><span style="color: #4f97d7;">[</span>j+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">0</span>
            <span style="color: #4f97d7; font-weight: bold;">else</span>:
                <span style="color: #7590db;">cur</span><span style="color: #4f97d7;">[</span>j+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span> = cur<span style="color: #4f97d7;">[</span>j<span style="color: #4f97d7;">]</span> + pre<span style="color: #4f97d7;">[</span>j+<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>

        <span style="color: #7590db;">pre</span> = <span style="color: #4f97d7;">[</span>i <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> cur<span style="color: #4f97d7;">]</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> pre<span style="color: #4f97d7;">[</span>-<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>
</pre>
</div>
</div>
</div>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://summerisgreen.com/blog/2017-07-07-2017-07-07-算法技巧-backtracking.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/author.png">
      <meta itemprop="name" content="Green">
      <meta itemprop="description" content="Abracadabra">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Summer is Green">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2017-07-07-2017-07-07-算法技巧-backtracking.html" class="post-title-link" itemprop="url">算法技巧-backtracking</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-07 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-07T00:00:00+08:00">2017-07-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-03-15 07:44:27" itemprop="dateModified" datetime="2019-03-15T07:44:27+08:00">2019-03-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程技巧/" itemprop="url" rel="index"><span itemprop="name">编程技巧</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
<div id="outline-container-orga9a49c9" class="outline-2">
<h2 id="orga9a49c9">Backtracking 算法</h2>
<div class="outline-text-2" id="text-orga9a49c9">
<p>
Backtracking（回溯)法是一个实用性非常强的算法，
它的核心思想正如其名字所蕴含的意思：沿着之前走的路退回到上一个岔路口，然后选择另一条路继续探索。
除了回溯思想之外，该算法的另一个关键就是对何时进行回溯，何时结束算法进行判断，而对这个的具体实现又是和所遇到的问题相关联。
</p>

<p>
将这两个关键点结合起来之后，我们可以得到回溯算法的一个非形式化的描述：
在搜索过程中，按照自定义的规则在遭遇的分支中进行选择；当所选择的分支为不可行(或者已被完全搜索时)，退回到上一个分支的分叉点，并在未被选取过的分支中选择一个，然后继续搜索。
</p>

<p>
回溯算法不仅原理简单，而且应用十分广泛。
该算法最常见的一种变体就是十分有名的在图或树中寻找可行解的深度优先搜索算法(Depth First Search)。
</p>

<p>
回溯算法算法应用广泛的一个原因就是其可以针对不同形式的解来做适当的变形，
以进行求解。
回溯算法对于具有不同解的形式的问题的求解思路将在下面一一介绍。
</p>
</div>
</div>
<div id="outline-container-org505664d" class="outline-2">
<h2 id="org505664d">回溯算法的应用</h2>
<div class="outline-text-2" id="text-org505664d">
<p>
在对回溯算法的实际编码过程中，由于递归调用的存在，可以很优雅的方式将回溯算法表示出来，而不需要实现复杂的回撤操作。
</p>

<p>
回溯算法最常见的应用是用来在有限的搜索集中寻找下面三种形式的解：
</p>
<ul class="org-ul">
<li>可行解</li>
<li>最优解</li>
<li>所有解</li>
</ul>

<p>
对于前两类问题，它们的问题形式比较固定，其求解过程直接套用下面介绍的思路即可。
而对查找所有可行解的问题，由于通常会需要去除冗余解并对求解过程进行加速，需要针对具体的需求进行适当的变形。
</p>
</div>
<div id="outline-container-orga67a304" class="outline-3">
<h3 id="orga67a304">可行解思路</h3>
<div class="outline-text-3" id="text-orga67a304">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">solve</span><span style="color: #4f97d7;">(</span>node, path<span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">path</span> += <span style="color: #4f97d7;">[</span>node<span style="color: #4f97d7;">]</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> leave?<span style="color: #4f97d7;">(</span>node<span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">return</span> path <span style="color: #4f97d7; font-weight: bold;">if</span> satisfy?<span style="color: #4f97d7;">(</span>path<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #a45bad;">None</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> c <span style="color: #4f97d7; font-weight: bold;">in</span> choice<span style="color: #4f97d7;">(</span>node<span style="color: #4f97d7;">)</span>:
        <span style="color: #7590db;">ans</span> = solve<span style="color: #4f97d7;">(</span>c, path<span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> ans <span style="color: #4f97d7; font-weight: bold;">is</span> <span style="color: #4f97d7; font-weight: bold;">not</span> <span style="color: #a45bad;">None</span>:
            <span style="color: #4f97d7; font-weight: bold;">return</span> ans

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">None</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf86fa90" class="outline-3">
<h3 id="orgf86fa90">最优解思路</h3>
<div class="outline-text-3" id="text-orgf86fa90">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #7590db;">best</span> = -<span style="color: #4f97d7;">float</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"inf"</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">find_best</span><span style="color: #4f97d7;">(</span>node, path<span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">path</span> += <span style="color: #4f97d7;">[</span>node<span style="color: #4f97d7;">]</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> leave?<span style="color: #4f97d7;">(</span>node<span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">if</span> satisfy?<span style="color: #4f97d7;">(</span>path<span style="color: #4f97d7;">)</span>:
            <span style="color: #7590db;">best</span> = <span style="color: #4f97d7;">max</span><span style="color: #4f97d7;">(</span>best, score<span style="color: #bc6ec5;">(</span>node<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

        <span style="color: #4f97d7; font-weight: bold;">return</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> c <span style="color: #4f97d7; font-weight: bold;">in</span> choice<span style="color: #4f97d7;">(</span>node<span style="color: #4f97d7;">)</span>:
        find_best<span style="color: #4f97d7;">(</span>c, path<span style="color: #4f97d7;">)</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org6b70b77" class="outline-3">
<h3 id="org6b70b77">寻找存在的所有解</h3>
<div class="outline-text-3" id="text-org6b70b77">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #7590db;">ans</span> = <span style="color: #4f97d7;">[]</span>

<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">find_all</span><span style="color: #4f97d7;">(</span>node, path<span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">path</span> += node
    <span style="color: #4f97d7; font-weight: bold;">if</span> leave?<span style="color: #4f97d7;">(</span>node<span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">if</span> satisfy?<span style="color: #4f97d7;">(</span>path<span style="color: #4f97d7;">)</span>:
            <span style="color: #7590db;">ans</span> += path

        <span style="color: #4f97d7; font-weight: bold;">return</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> c <span style="color: #4f97d7; font-weight: bold;">in</span> choice<span style="color: #4f97d7;">(</span>node<span style="color: #4f97d7;">)</span>:
        find_all<span style="color: #4f97d7;">(</span>c, path<span style="color: #4f97d7;">)</span>

</pre>
</div>

<p>
对于寻找存在的所有解的问题，一般不仅需要找到所有解，还要求找到的解不能重复;
为了满足这个需求需要增加一些额外的操作，具体将结合下面这个来自 leetcode 的题目进行说明。
</p>
</div>
<div id="outline-container-orgcadb8c7" class="outline-4">
<h4 id="orgcadb8c7">Combination Sum II</h4>
<div class="outline-text-4" id="text-orgcadb8c7">
<pre class="example">
Given a collection of candidate numbers (C) and a target number (T), find all unique combinations in C where the candidate numbers sums to T.

Each number in C may only be used once in the combination. 
</pre>

<p>
该题目的难点就是如何高效地找出所有不重复的结果。
</p>

<p>
首先需要做的是对整个原始数据进行排序，
因为这用可以方便后面过滤掉重复的结果，并且可以使得后续的运算时间减少一个常数因子（为之前的几分之一）。
而这个方法对整个程序的时间效率的影响不大，对候选对象的排序的时间复杂度为 O(n * lg(n))
和整个搜索过程的时间复杂度(O(n^2))不是一个量级上的。
</p>

<p>
在之前的解算思路上还添加了 e &lt;= target and (i &lt; 1 or candidates[i] != candidates[i-1]) 这个判定条件。
这个条件的前面部分减少了搜索的计算量，后面部分则在当前分叉点上跳过与之前相同的选择保证了搜索结果的不重复。
</p>

<p>
搜索结果的不重复性可以通过对递归式 csIter 进行循环不变式分析来证明。
</p>

<ul class="org-ul">
<li>循环不变式：相同长度的 comb ，其值不相同。</li>
<li>初始化：第一次迭代之前，长度为0的 comb，不包含任何值。成立。</li>
<li>保持：假设当 comb 中元素个数为 n 时，之前计算出的 comb 不重复，对于满足条件 i &lt; 1 or candidates[i] != candidates[i-1] 的结果，其添加的新元素能保证新的 comb 不重复。因此完成此步添加操作的 comb不会产生重复。</li>
<li>终止：当循环终止时，长度相同的 comb 中的值不同。</li>
</ul>

<p>
所以对于最终结果中的解，不是不同的长度的值，要不就是相同的长度但不重复的值，所以其结果必然不重复。
</p>

<p>
看了上面的推理，对于重复性的问题应该是解决了，但是可能会引发另一个担忧：过滤掉了这些条件，会不会导致最终的结果不完整。
为了消除这个疑虑，只要证明过滤掉的搜索结果都是在现有结果中已有的即可。
对于去除的元素，其满足下面的条件：i &gt; 0 并且 candidates[i] == candidates[i-1]。
也就是说去除的潜在对象是作为新符合条件的候选项，已经在子程序中添加过到 comb 中的。
而当前的 comb 和前一个潜在对象的时候相同，并且当前的潜在对象是之前的潜在对象的子集，
因此该条件下产生的结果是之前的结果的子集。
所有过滤掉判定条件之后的结果依然是完整的。
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">combinationSum2</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>, candidates, target<span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae;">"""</span>
<span style="color: #2aa1ae;">    :type candidates: List[int]</span>
<span style="color: #2aa1ae;">    :type target: int</span>
<span style="color: #2aa1ae;">    :rtype: List[List[int]]</span>
<span style="color: #2aa1ae;">    """</span>
    <span style="color: #7590db;">ans</span> = <span style="color: #4f97d7;">[]</span>
    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">csIter</span><span style="color: #4f97d7;">(</span>candidates, target, comb<span style="color: #4f97d7;">)</span>:
        <span style="color: #4f97d7; font-weight: bold;">if</span> target == <span style="color: #a45bad;">0</span>:
            ans.append<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span>i <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> comb<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> i, e <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">enumerate</span><span style="color: #4f97d7;">(</span>candidates<span style="color: #4f97d7;">)</span>:
            <span style="color: #4f97d7; font-weight: bold;">if</span> e &lt;= target <span style="color: #4f97d7; font-weight: bold;">and</span> <span style="color: #4f97d7;">(</span>i &lt; <span style="color: #a45bad;">1</span> <span style="color: #4f97d7; font-weight: bold;">or</span> candidates<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span> != candidates<span style="color: #bc6ec5;">[</span>i-<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>:
                comb.append<span style="color: #4f97d7;">(</span>e<span style="color: #4f97d7;">)</span>
                csIter<span style="color: #4f97d7;">(</span>candidates<span style="color: #bc6ec5;">[</span>i+<span style="color: #a45bad;">1</span>:<span style="color: #bc6ec5;">]</span>, target-e, comb<span style="color: #4f97d7;">)</span>
                comb.pop<span style="color: #4f97d7;">()</span>
    csIter<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">sorted</span><span style="color: #bc6ec5;">(</span>candidates<span style="color: #bc6ec5;">)</span>, target, <span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> ans
</pre>
</div>

<p>
在 leetcode 上的另一个中档难度的题可以采用和本题相同的技巧来解决，其问题及解法如下所示。
</p>
</div>
</div>

<div id="outline-container-orgf3b6533" class="outline-4">
<h4 id="orgf3b6533">Subsets II</h4>
<div class="outline-text-4" id="text-orgf3b6533">
<pre class="example">
Given a collection of integers that might contain duplicates, nums, return all possible subsets. 
</pre>

<p>
该题目除了没有了 target 目标的约束之外，和之前的题目类似。
在实际求解的过程中，只要将之前的解放中和 target 相关的表达式删去即可。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">subsetsWithDup</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">self</span>, nums<span style="color: #4f97d7;">)</span>:
    <span style="color: #2aa1ae;">"""</span>
<span style="color: #2aa1ae;">    :type nums: List[int]</span>
<span style="color: #2aa1ae;">    :rtype: List[List[int]]</span>
<span style="color: #2aa1ae;">    """</span>
    <span style="color: #7590db;">ans</span> = <span style="color: #4f97d7;">[]</span>

    <span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">swdIter</span><span style="color: #4f97d7;">(</span>candidates, comb<span style="color: #4f97d7;">)</span>:
        ans.append<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span>i <span style="color: #4f97d7; font-weight: bold;">for</span> i <span style="color: #4f97d7; font-weight: bold;">in</span> comb<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

        <span style="color: #4f97d7; font-weight: bold;">for</span> i, e <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">enumerate</span><span style="color: #4f97d7;">(</span>candidates<span style="color: #4f97d7;">)</span>:
            <span style="color: #4f97d7; font-weight: bold;">if</span> i &lt; <span style="color: #a45bad;">1</span> <span style="color: #4f97d7; font-weight: bold;">or</span> candidates<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span> != candidates<span style="color: #4f97d7;">[</span>i-<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>:
                comb.append<span style="color: #4f97d7;">(</span>e<span style="color: #4f97d7;">)</span>
                swdIter<span style="color: #4f97d7;">(</span>candidates<span style="color: #bc6ec5;">[</span>i+<span style="color: #a45bad;">1</span>:<span style="color: #bc6ec5;">]</span>, comb<span style="color: #4f97d7;">)</span>
                comb.pop<span style="color: #4f97d7;">()</span>
    swdIter<span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">sorted</span><span style="color: #bc6ec5;">(</span>nums<span style="color: #bc6ec5;">)</span>, <span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> ans
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgada5970" class="outline-2">
<h2 id="orgada5970">参考</h2>
<div class="outline-text-2" id="text-orgada5970">
<ol class="org-ol">
<li><a href="https://segmentfault.com/a/1190000006121957" target="_blank" rel="noopener">(Leetcode) Backtracking回溯法(又称DFS,递归)全解</a></li>
<li><a href="https://leetcode.com/problems/combination-sum-ii/#/description" target="_blank" rel="noopener">leetcode Combination Sum II</a></li>
<li><a href="https://leetcode.com/problems/subsets-ii/#/description" target="_blank" rel="noopener">leetcode Subsets II</a></li>
</ol>
</div>
</div>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://summerisgreen.com/blog/2016-11-26-2016-11-26-巧用异或找出唯一出现奇数次的数字.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/author.png">
      <meta itemprop="name" content="Green">
      <meta itemprop="description" content="Abracadabra">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Summer is Green">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2016-11-26-2016-11-26-巧用异或找出唯一出现奇数次的数字.html" class="post-title-link" itemprop="url">巧用异或找出唯一出现奇数次的数字</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-11-26 00:00:00" itemprop="dateCreated datePublished" datetime="2016-11-26T00:00:00+08:00">2016-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-03-15 07:44:29" itemprop="dateModified" datetime="2019-03-15T07:44:29+08:00">2019-03-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程技巧/" itemprop="url" rel="index"><span itemprop="name">编程技巧</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>
异或操作看似是数字逻辑的一个很简单的运算方法，
但却具有一些很有用的特性，用好的话，对一些问题的解决可以起到四两拨千斤的效果。
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/blog/2016-11-26-2016-11-26-巧用异或找出唯一出现奇数次的数字.html#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Green"
      src="/img/author.png">
  <p class="site-author-name" itemprop="name">Green</p>
  <div class="site-description" itemprop="description">Abracadabra</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Green</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
